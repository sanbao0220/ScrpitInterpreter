// =======================
// 京东客服文本脚本（新版规范）
// =======================
// 数据库结构设计：
// 1. user表：存储用户信息
//    - user_name TEXT
//    - is_vip BOOLEAN
//    - order_id INT PRIMARY KEY
//    - status TEXT(交易成功，已退货，已换货)
//    - price DECIMAL
// =======================
// 规则说明：
// 1. 必须包含 welcome、exit、fail 三个基础Step。
// 2. 其它Step为具体业务功能，如订单、退换货、投诉、人工等。
// 3. actions 支持：
//    - Speak <内容>         // 机器人说话，支持变量如 $name。遇到$变量时，需在构造分析树节点时自动用数据库中对应字段的数据进行替换。
//    - Listen <min>, <max>  // 监听用户输入，参数为最短和最长等待时间（秒）
//    - UPGRATE <变量名> <值> // 修改数据库中对应字段的值，如 UPGRATE $status "已处理"
// 4. branch 统一用 Branch "<关键词>", <stepName> 表示：
//    - 业务关键词分支：如 Branch "投诉", complainProc
//    - Branch "意图识别失败", fail 表示无输入或无法识别
// 5. 支持条件分支：
//    - If <条件> Then <stepName>，如 If $is_vip == true Then vipProc
//    - 条件表达式支持变量、数值、字符串的比较（==, !=, >, <, >=, <=）
//    - 条件分支优先于普通Branch分支，满足条件即跳转
// 6. 变量用 $name 形式表示，所有$变量均应与数据库字段一一对应，遇到$变量时自动从数据库获取数据进行替换
// =======================

Step welcome
    If $is_vip == true Then vipProc
    Speak $name + "您好，欢迎致电京东客服，请问有什么可以帮您？"
    Listen 5, 20
    Branch "订单", orderProc
    Branch "退换货", returnProc
    Branch "投诉", complainProc
    Branch "人工", humanProc
    Branch "意图识别失败", fail

Step vipProc
    Speak "尊贵的京东PLUS会员，欢迎您的来电！请问有什么可以帮您？"
    Listen 5, 20
    Branch "订单", orderProc
    Branch "退换货", returnProc
    Branch "投诉", complainProc
    Branch "人工", humanProc
    Branch "意图识别失败", fail
    Branch "结束", exit

Step orderProc
    Speak "请提供您的订单号，我来为您查询订单信息。"
    Listen 5, 30
    If $order_id == null Then orderNotFound
    Speak "您的订单号为" + $order_id + "，订单状态：" + $status + "，金额：" + $price + "元。"
    Branch "意图识别失败", fail
    Branch "人工", humanProc
    Branch "结束", exit

Step orderNotFound
    Speak "未查询到您的订单信息，请确认订单号是否正确。"
    Listen 5, 20
    Branch "订单", orderProc
    Branch "人工", humanProc
    Branch "意图识别失败", fail
    Branch "结束", exit

Step returnProc
    Speak "请问您需要退货还是换货？"
    Listen 5, 30
    If $status == "已退货" Then alreadyRefund
    If $status == "已换货" Then alreadyExchanged
    Branch "退货", refundProc
    Branch "换货", exchangeProc
    Branch "意图识别失败", fail
    Branch "人工", humanProc
    Branch "结束", exit

Step alreadyRefund
    Speak "您的订单已经完成退货，无需重复操作。"
    Listen 5, 20
    Branch "订单", orderProc
    Branch "人工", humanProc
    Branch "意图识别失败", fail
    Branch "结束", exit

Step alreadyExchanged
    Speak "您的订单已经完成换货，无需重复操作。"
    Listen 5, 20
    Branch "订单", orderProc
    Branch "人工", humanProc
    Branch "意图识别失败", fail
    Branch "结束", exit

Step refundProc
    Speak "您的退货申请已受理，我们会尽快为您处理。"
    UPGRATE $status "已退货"
    Listen 1, 1
    Branch "意图识别失败", fail
    Branch "结束", exit

Step exchangeProc
    Speak "您的换货申请已受理，我们会尽快为您安排。"
    UPGRATE $status "已换货"
    Listen 1, 1
    Branch "意图识别失败", fail
    Branch "结束", exit

Step complainProc
    Speak "很抱歉给您带来不便，请描述您的投诉内容，我们会尽快处理。"
    Listen 5, 50
    UPGRATE $status "投诉处理中"
    Branch "意图识别失败", fail
    Branch "人工", humanProc
    Branch "结束", exit

Step humanProc
    Speak "正在为您转接人工客服，请稍候。"
    Listen 1, 1
    Branch "意图识别失败", fail
    Branch "结束", exit

Step fail
    Speak "没有听清您的需求，请您再说一遍好吗？"
    Listen 5, 20
    Branch "订单", orderProc
    Branch "退换货", returnProc
    Branch "投诉", complainProc
    Branch "人工", humanProc
    Branch "意图识别失败", fail
    Branch "结束", exit

Step exit
    Speak "感谢您的来电，祝您生活愉快，再见！"
